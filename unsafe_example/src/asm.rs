use std::arch::asm;

pub fn main() {
    unsafe {
        asm!("nop");
    }

    out();
    in_();
    add();
    direct();
    inlateout();
    // operate();
    mul(10, 20);
}

fn out() {
    let x: u64;
    unsafe {
        //è¿™é‡Œå®šä¹‰å¯„å­˜å™¨ä½œä¸ºè¾“å‡º
        //æŠŠå¯„å­˜å™¨ä¸­å­˜å‚¨çš„5å†™å›žåˆ°xå˜é‡çš„åœ°å€ä¸­
        //ä¸åŒæž¶æž„çš„å¤„ç†å™¨çš„æœ€ç»ˆæ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¼šä¸åŒ
        asm!("mov {},5",out(reg) x);
    }
    assert_eq!(x, 5);
}

fn in_() {
    let i: u64 = 3;
    let o: u64;
    unsafe {
        //è¿™é‡Œè¡¨ç¤ºå°†iå˜é‡ä½œä¸ºè¾“å…¥å€¼ï¼Œå°†è¾“å…¥å€¼è¾“å‡ºåˆ°å˜é‡o
        //mov out(reg) o,in(reg) i
        //è¿™é‡Œè¡¨ç¤ºå°†5åŠ åˆ°è¾“å‡ºå˜é‡o
        //add out(reg) o,5
        asm!(
        "mov {0},{1}",
        "add {0},5",
        out(reg) o,
        in(reg) i
        )
    }
    println!("æœ€ç»ˆå¾—åˆ°å€¼:{}", o);
    assert_eq!(o, 8);
}

fn add() {
    let mut x: u64 = 3;
    //è¿™é‡Œçš„inoutï¼Œè¡¨ç¤ºå˜é‡ä½œä¸ºå€¼è¾“å…¥åˆ°addæŒ‡ä»¤ï¼Œå¹¶ä¸”ç»“æžœè¾“å‡ºåˆ°xå˜é‡ä¸­
    unsafe { asm!("add {0},5",inout(reg) x) }
    assert_eq!(x, 8);
    println!("addå‡½æ•°ï¼Œæœ€ç»ˆå¾—åˆ°è¾“å‡ºå€¼:{x}")
}

fn direct() {
    let x: u64 = 3;
    let y: u64;
    unsafe {
        //è¿™é‡Œé€šè¿‡=>ï¼Œè¡¨ç¤ºxä½œä¸ºè¾“å…¥ï¼Œyä½œä¸ºè¾“å‡º
        //å°±å®žçŽ°äº†è®©xçš„å€¼å’Œ5ç›¸åŠ ï¼Œå†æŠŠç»“æžœè¾“å‡ºç»™y
        asm!("add {0},5",inout(reg) x=>y)
    }
    println!("x:{x},y:{y}")
}

fn inlateout() {
    let mut a: u64 = 4;
    let b: u64 = 4;
    let c: u64 = 4;
    unsafe {
        //æŠŠbçš„ç»“æžœåŠ ç»™äº†a
        //å¹¶ä¸”æœ‰æŠŠcçš„ç»“æžœåŠ ç»™äº†a
        asm!("add {0},{1}",
            "add {0},{2}",
        //å¦‚æžœè¿™é‡Œç”¨inlateoutï¼Œå¹¶ä¸”ä¼˜åŒ–æ¨¡å¼ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä¼šè¢«aå’Œcåˆ†é…åŒä¸€ä¸ªå¯„å­˜å™¨
        //è¿™æ ·å°±å¯¼è‡´ç¬¬ä¸€æ¡addæ‰§è¡ŒåŽï¼Œa=8
        //ç¬¬äºŒæ¡æŒ‡ä»¤ä¼šå˜æˆa+8=16
        //å› ä¸ºä¼˜åŒ–å™¨è§‰å¾—aå’Œcåœ¨æ‰§è¡ŒaddæŒ‡ä»¤ä¹‹å‰éƒ½èƒ½è¢«è¯»å–ï¼Œå°±è§‰å¾—æŠŠaå’Œcæ”¾åˆ°ä¸€ä¸ªå¯„å­˜å™¨é‡Œé¢æ˜¯å®‰å…¨çš„(wtf?ðŸ®)
            inout(reg) a,
            in(reg) b,
            in(reg) c);
    }
    println!("açš„å€¼:{a}");

    let mut a: u64 = 4;
    let b: u64 = 4;
    unsafe {
        asm!("add {0},{1}",
        //è¯»å–å®Œæ‰€æœ‰è¾“å…¥åŽï¼Œæ‰åˆ†é…lateoutçš„å¯„å­˜å™¨
        inlateout(reg) a,
        in(reg) b)
    }

    println!("a:{a}")
}

fn operate() {
    let cmd = 0xd1;
    unsafe {
        //å°†32ä½å€¼å˜é‡åŠ è½½åˆ°eaxå¯„å­˜å™¨ï¼Œ
        // å¹¶ä¸”æŠŠeaxå¯„å­˜å™¨å†…å®¹è¾“å‡ºåˆ°0x64ç«¯å£
        //è¿™é‡Œçš„outä¸åŒä½æ•°éœ€è¦ä½¿ç”¨ä¸åŒçš„å¯„å­˜å™¨
        //8ä½ç”¨a1 16ä½ç”¨ax 32ä½ç”¨eax
        asm!("out 0x64,eax",in("eax") cmd);
    }
}

fn mul(a: u64, b: u64) -> u128 {
    let lo: u64;
    let hi: u64;
    unsafe {
        //æŒ‡ä»¤å†…éƒ¨ç›¸ä¹˜,åè¿›åˆ¶è½¬åŒ–ä½äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”å†…éƒ¨é€šè¿‡ä¼ ç»Ÿç±»ä¼¼ç«–å¼ä¹˜æ³•
        //æ¯ä¸€ä½ç›¸ä¹˜ï¼Œå†æŠŠç»“æžœç›¸åŠ ï¼Œå†æŠŠä¸åŒçš„ä½çš„äºŒè¿›åˆ¶å€¼å­˜æ”¾åˆ°ä¸åŒçš„å¯„å­˜å™¨(ä½Ž64ä½ï¼Œé«˜64ä½)
        asm!("mul {}",
            in(reg) a,
            inlateout("rax") b=>lo,
            lateout("rdx") hi)
    }
    println!("lo:{lo},hi:{hi}");
    ((hi as u128) << 64) + lo as u128
}
